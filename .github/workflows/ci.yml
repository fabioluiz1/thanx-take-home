name: CI

on:
  pull_request:

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Validate branch name
        run: scripts/check-branch-name
        env:
          BRANCH_NAME: ${{ github.head_ref }}

      - name: Validate PR commit authors
        run: scripts/ci-validate-pr-commits
        env:
          BASE_REF: ${{ github.event.pull_request.base.sha }}
          HEAD_REF: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit checks
        run: |
          pre-commit run --all-files --hook-stage pre-commit
          pre-commit run prettier --all-files --hook-stage manual
        env:
          # Skip hooks that run as separate steps or require specific setup
          # Skipped: check-branch-name, validate-commit-author (run above),
          #          rubocop, web-eslint, web-vitest, terraform-validate (run as separate CI jobs)
          # Skipped prettier in pre-commit stage (runs in manual stage with --check)
          # Runs: markdownlint, hadolint-docker, trailing-whitespace,
          #       end-of-file-fixer, check-yaml, check-added-large-files,
          #       check-merge-conflict, prettier (check-only)
          SKIP: check-branch-name,validate-commit-author,rubocop,web-eslint,prettier,web-vitest,terraform-validate

  web-lint:
    name: Web Lint (ESLint)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Run ESLint
        run: bun run lint

  web-typecheck:
    name: Web Type Check (TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Run TypeScript type check
        run: bun run type-check

  web-test:
    name: Web Tests (Vitest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Run Vitest tests
        run: bun run test -- --run

  terraform_validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.0"

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate
